-- title:  Legendary Waffle ðŸ§‡
-- author: CodeBaker & Leonard1on
-- desc:   Game Off 2020 Entry
-- script: lua
function isSolid(x, y)
    return solidTiles[mget((x) // 8, (y) // 8)]
end

function writeSpeech(text)
    final = ''
    for i = 1, #text do
        final = final .. string.sub(text, i, i)
        if i % 38 == 0 then
            final = final .. '\n'
        end
    end
    rect(0, (136 * 0.75) // 1, 240, 136 * 0.25, 8)
    rectb(0, (136 * 0.75) // 1, 240, 136 * 0.25, 4)
    print(final, 5, (136 * 0.75) + 5 // 1, 12, true)
    seconds = (ticks // 60)
    if seconds % 2 == 0 then
        tri(235, 129, 229, 129, 232, 132, 12)
    end
end

function init()
    ticks = 0
    game = {}
    p = {
        image = 256,
        x = 88,
        y = 80,
        vx = 0,
        vy = 0,
        flip = 0,
        moveY = function(self)
            self.y = self.y + self.vy;
        end,
        moveX = function(self)
            self.x = self.x + self.vx;
        end,
        walkingAnimation = function(self)
            t = 1 + ticks % 60 // 30
            self.image = 256 + t
        end,
        fallingAnimation = function(self)
            self.image = 259
        end,
        isGrounded = function(self)
            return self.vy == 0
        end,
        testMovement = function(self)
            if isSolid(self.x + self.vx, self.y + self.vy) or isSolid(self.x + 7 + self.vx, self.y + self.vy) or
                isSolid(self.x + self.vx, self.y + 7 + self.vy) or isSolid(self.x + 7 + self.vx, self.y + 7 + self.vy) then
                self.vx = 0
            end

            if isSolid(self.x, self.y + 8 + self.vy) or isSolid(self.x + 7, self.y + 8 + self.vy) then
                self.vy = 0
            else
                self.vy = self.vy + 0.2
            end

            if self.vy < 0 and
                (isSolid(self.x + self.vx, self.y + self.vy) or isSolid(self.x + 7 + self.vx, self.y + self.vy)) then
                self.vy = 0
            end
            if self:isGrounded() and btnp(4) then
                self.vy = -2.5
            end
        end,
        update = function(self)
            if btn(2) then
                p.vx = -1
                p.flip = 1
            elseif btn(3) then
                p.vx = 1
                p.flip = 0
            else
                p.vx = 0
            end
            self:testMovement()
            if btn(1) and not btn(2) and not btn(3) and not btn(4) then
                p.image = 272
            end
            p:moveX()
            p:moveY()
        end,
        render = function(self)
            if self:isGrounded() and (btn(2) or btn(3)) then
                self:walkingAnimation()
            elseif not self:isGrounded() then
                self:fallingAnimation()
            end
            spr(self.image, self.x, self.y, 6, 1, self.flip)
            self.image = 256
        end
    }
    solidTiles = {
        [0] = false,
        [1] = true,
        [2] = true
    }
end

init()
function TIC()
    cls(12)
    map(0, 0, 30, 17)
    spr(258, 29 * 8, 5 * 8, 15)

    p:update()
    p:render()
    -- writeSpeech("The quick brown fox jumps over the lazy dog")
    ticks = ticks + 1
end

-- <TILES>
-- 000:9999999999999999999999999999999999999999999999999999999999999999
-- 001:6666666666666666363636363333333333333333333333333333333333333333
-- 002:3333333333333333333333333333333333333333333333333333333333333333
-- </TILES>

-- <SPRITES>
-- 000:66eee6666eeee6666404066664444666622c2666624c2466688886666e66e666
-- 001:66eee6666eeee6666404066664444666622c2466642c266668888e666e666666
-- 002:66eee6666eeee6666404066664444666622c2666624c2466e88886666666e666
-- 003:66eee6666eeee6666444466664040666624c2466622c2666688886666e66e666
-- 016:6666666666eee6666eeee6666404066664444666622c2666624c246668e88e66
-- 096:ff604ffff66444faf66044f1f66444f142666664ff6666f1ff3333ffff2ff2ff
-- 236:cffcfffcccffcfccfcfcffcfffffffffcff44ffcff4343fff433333f4ccccccc
-- 237:00cccc00000cccc000cc2c20cc1cccc00cc1cc000ccc100000ccc00000000000
-- 238:00000000000000ee00000eee0000eeee0000eee50000ee540000ee5400000554
-- 239:00000000eeee0000eeeee000eeee000055550000040400004444000044440000
-- 254:00000112000001120000014200000889000008890000008900000089000000ee
-- 255:2cc20000ccc20000ccc2400099990000999900000089000000890000e0eee000
-- </SPRITES>

-- <MAP>
-- 006:100000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 007:200000000000000000000000000000000000000000000000000000001020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 008:200000000000000000000000000000000000000000000000000000102020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 009:200000000000000000000000000000000000000000000000000010202020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 010:200000000000000000000000000000000000000000000000001020202020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 011:201010101010101010101010101010101010101010101010102020202020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 014:000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- </MAP>

-- <WAVES>
-- 000:00000000ffffffff00000000ffffffff
-- 001:0123456789abcdeffedcba9876543210
-- 002:0123456789abcdef0123456789abcdef
-- </WAVES>

-- <SFX>
-- 000:010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100404000000000
-- </SFX>

-- <PALETTE>
-- 000:1a1c2c8d0cd2d2182cef7d57ffcd75ce915938b76425717929366f3b5dc941a6f673eff7f4f4f494b0c2441c0059280c
-- </PALETTE>

